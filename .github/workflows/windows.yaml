name: windows
on: [push, pull_request]

defaults:
  run:
    shell: pwsh

jobs:
  build:
    runs-on: ${{matrix.image}}
    strategy:
      matrix:
        image: [windows-2019]
        config: [debug, release]
        std: [14]
        compiler: [cl]

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Checkout vcpkg
        uses: actions/checkout@v2
        with:
          repository: microsoft/vcpkg
          path: vcpkg

      - name: Configure
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg
        run: >
          cmake
          --preset x64-windows-${{ matrix.compiler }}-std${{ matrix.std }}-${{ matrix.config }}
          -B out/build
          -G "Visual Studio 16 2019"
          .

      - name: Build
        run: cmake --build out/build

      - name: Test
        working-directory: out/build
        run: ctest -C ${{ matrix.config }} --verbose --output-on-failure
